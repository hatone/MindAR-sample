<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Door Usage AR Overlay</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="overlay" id="start-overlay">
    <div class="panel">
      <h1>Door Usage AR Overlay</h1>
      <p>Tap “Start AR” and point your camera at the target door.</p>
      <p class="note">Requires camera permission. Use HTTPS on mobile; HTTP is fine for desktop testing.</p>
      <p id="asset-status" class="note warn">Checking for ./assets/door-targets.mind …</p>
      <p id="ar-status" class="note"></p>
      <button id="start-button" disabled>Start AR</button>
    </div>
  </div>

  <div id="ar-container" class="ar-container"></div>
  <div id="debug-info" class="note debug"></div>

  <script type="module">
    import { MindARThree } from "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js";
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";

    const startButton = document.getElementById("start-button");
    const overlayEl = document.getElementById("start-overlay");
    const assetStatus = document.getElementById("asset-status");
    const arStatus = document.getElementById("ar-status");
    const debugInfo = document.getElementById("debug-info");
    const container = document.getElementById("ar-container");

    let mindarThree;
    let overlayGroup;

    const checkMindFile = async () => {
      try {
        const res = await fetch("./assets/door-targets.mind", { method: "HEAD" });
        if (!res.ok) throw new Error("target file missing");
        const size = res.headers.get("content-length");
        assetStatus.textContent = `Target file detected (${size ? `${(Number(size) / 1024).toFixed(1)} KB` : "size unknown"})`;
        assetStatus.classList.remove("warn");
        startButton.disabled = false;
      } catch (err) {
        assetStatus.textContent = "Missing: ./assets/door-targets.mind — generate with the MindAR Image Target Compiler and place it under /web/assets.";
        assetStatus.classList.add("warn");
        startButton.disabled = true;
      }
    };

    const ensureCameraAccess = async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error("Camera API unsupported. Use a modern browser.");
      }
      const constraints = { video: { facingMode: { ideal: "environment" } }, audio: false };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      stream.getTracks().forEach((t) => t.stop());
    };

    const createTextTexture = () => {
      const canvas = document.createElement("canvas");
      canvas.width = 1024;
      canvas.height = 512;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#0f172a";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#f8fafc";
      ctx.font = "48px 'Noto Sans JP', -apple-system, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      const lines = ["ドアの使い方：", "1. カードキーをここにタッチ", "2. ランプが緑になったら開けてください"];
      lines.forEach((line, i) => {
        ctx.fillText(line, canvas.width / 2, canvas.height / 2 - 70 + i * 70);
      });
      const texture = new THREE.CanvasTexture(canvas);
      texture.encoding = THREE.sRGBEncoding;
      return texture;
    };

    const buildOverlay = () => {
      const group = new THREE.Group();
      const bgMat = new THREE.MeshBasicMaterial({
        color: 0x0f172a,
        transparent: true,
        opacity: 0.85,
        side: THREE.DoubleSide,
        depthTest: false
      });
      const bg = new THREE.Mesh(new THREE.PlaneGeometry(1.6, 0.9), bgMat);
      bg.position.set(0, 0.3, 0);
      bg.renderOrder = 10;
      group.add(bg);

      const textTexture = createTextTexture();
      const textMat = new THREE.MeshBasicMaterial({
        map: textTexture,
        transparent: true,
        side: THREE.DoubleSide,
        depthTest: false
      });
      const textPlane = new THREE.Mesh(new THREE.PlaneGeometry(1.5, 0.7), textMat);
      textPlane.position.set(0, 0.3, 0.01);
      textPlane.renderOrder = 11;
      group.add(textPlane);

      group.visible = false;
      return group;
    };

    const startAR = async () => {
      arStatus.textContent = "Starting AR…";
      try {
        await ensureCameraAccess();
        mindarThree = new MindARThree({
          container,
          imageTargetSrc: "./assets/door-targets.mind",
          uiLoading: "no",
          uiScanning: "no",
          uiError: "no",
          warmupTolerance: 5,
          missTolerance: 10,
          filterMinCF: 0.0001,
          maxTrack: 1
        });

        const { renderer, scene, camera } = mindarThree;
        renderer.setClearColor(0x000000, 0);
        scene.environment = null;
        scene.add(new THREE.AmbientLight(0xffffff, 1));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(0, 2, 1);
        scene.add(dirLight);

        const anchor = mindarThree.addAnchor(0);
        overlayGroup = buildOverlay();
        anchor.group.add(overlayGroup);

        anchor.onTargetFound = () => {
          overlayGroup.visible = true;
          setTimeout(() => {
            scene.updateMatrixWorld(true);
            const overlayWorld = overlayGroup.getWorldPosition(new THREE.Vector3());
            const debugText = `Overlay world z: ${overlayWorld.z.toFixed(3)}`;
            if (debugInfo) debugInfo.textContent = debugText;
            arStatus.textContent = "✓ Door detected. Overlay visible.";
          }, 150);
        };
        anchor.onTargetLost = () => {
          overlayGroup.visible = false;
          arStatus.textContent = "Searching for the door target…";
          if (debugInfo) debugInfo.textContent = "Searching…";
        };

        await mindarThree.start();
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });

        overlayEl.classList.add("hidden");
        arStatus.textContent = "Camera ready. Point at the door target.";
      } catch (err) {
        arStatus.textContent = `Failed to start AR: ${err?.message || "Camera blocked"}. Please allow camera access and reload.`;
        console.error("AR start error", err);
      }
    };

    startButton.addEventListener("click", async () => {
      await startAR();
    });

    checkMindFile();
  </script>
</body>
</html>
